# Role: kde
# Description: KDE Desktop configuration and dotfiles
# Migrated from: install-software-scripts/14-kde.sh

- name: Create KDE backup directory
  file:
    path: /tmp/kde/.config
    state: directory
    mode: '0755'

- name: Check if KDE configuration files are real files
  stat:
    path: "~/.config/{{ item }}"
  loop:
    - discoverrc
    - dolphinrc
    - kdeglobals
    - kglobalshortcutsrc
    - konsolerc
    - konsolesshconfig
    - plasmarc
    - ksmserverrc
    - kwinrc
    - kscreenlockerrc
    - klipperrc
    - plasmashellrc
    - khotkeysrc
    - powermanagementprofilesrc
  register: kde_file_stats

- name: Backup existing KDE configuration files
  command: mv ~/.config/{{ item.item }} /tmp/kde/.config/
  args:
    removes: "~/.config/{{ item.item }}"
  loop: "{{ kde_file_stats.results }}"
  when: item.stat.exists and not item.stat.islnk
  failed_when: false

- name: Check if KDE configuration directories are real directories
  stat:
    path: "{{ item }}"
  loop:
    - ~/.config/xsettingsd
    - ~/.local/share/konsole
  register: kde_dir_stats

- name: Backup existing KDE configuration directories
  command: mv {{ item.item }} /tmp/kde/
  args:
    removes: "{{ item.item }}"
  loop: "{{ kde_dir_stats.results }}"
  when: item.stat.exists and not item.stat.islnk
  failed_when: false

- name: Deploy KDE dotfiles
  command: stow -v -d {{ setup_repo }}/dotfiles/ -t ~ kde
  args:
    chdir: "{{ setup_repo }}/dotfiles"
  register: stow_kde
  changed_when: "'LINK' in (stow_kde.stderr | default(''))"
