# Role: nvm
# Description: Install NVM and specified Node.js versions
# Migrated from: install-software-scripts/35-nvm.sh

- name: Check if NVM is installed
  stat:
    path: ~/.nvm/nvm.sh
  register: nvm_stat

- name: Get latest NVM version from GitHub
  uri:
    url: https://api.github.com/repos/nvm-sh/nvm/releases/latest
    return_content: yes
  register: nvm_latest_release
  when: not nvm_stat.stat.exists

- name: Set NVM version fact
  set_fact:
    nvm_version_to_install: "{{ nvm_latest_release.json.tag_name | default('master') }}"
  when: not nvm_stat.stat.exists

- name: Download and install NVM
  shell: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/{{ nvm_version_to_install | default('master') }}/install.sh | bash
  when: not nvm_stat.stat.exists

- name: Install Node.js versions
  shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install {{ item }}
  args:
    executable: /bin/bash
    creates: "~/.nvm/versions/node/{{ item }}"
  loop: "{{ node_versions }}"
