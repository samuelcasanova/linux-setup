# Role: vscode
# Description: Install VS Code and manage extensions and dotfiles
# Migrated from: install-software-scripts/36-vscode.sh

- name: Download VS Code GPG key
  get_url:
    url: https://packages.microsoft.com/keys/microsoft.asc
    dest: /tmp/microsoft.asc
    mode: '0644'

- name: Dearmor VS Code GPG key
  command: gpg --dearmor -o /etc/apt/keyrings/microsoft.gpg /tmp/microsoft.asc
  args:
    creates: /etc/apt/keyrings/microsoft.gpg
  become: yes

- name: Remove problematic VS Code repository files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/archive_uri-https_packages_microsoft_com_repos_vscode-noble.list
    - /etc/apt/sources.list.d/vscode.sources
  become: yes

- name: Remove VS Code key from legacy trusted.gpg
  shell: apt-key del EB3E94ADBE1229CF
  become: yes
  failed_when: false # Might fail if key not present, which is fine

- name: Add VS Code repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/vscode stable main"
    state: present
    filename: vscode
  become: yes

- name: Install VS Code
  apt:
    name: code
    state: present
    update_cache: yes
  become: yes

- name: Install VS Code extensions
  command: code --install-extension {{ item }}
  loop: "{{ vscode_extensions }}"
  register: extension_install
  changed_when: "'is already installed' not in extension_install.stdout"
  failed_when: false # Extension install might fail in headless/Docker environments

- name: Create VS Code backup directory
  file:
    path: /tmp/vscode
    state: directory
    mode: '0755'

- name: Check if VS Code configuration files are real files
  stat:
    path: "{{ item }}"
  loop:
    - ~/.config/Code/User/keybindings.json
    - ~/.config/Code/User/settings.json
    - ~/.config/Code/User/snippets
  register: vscode_stats

- name: Backup existing VS Code configuration
  command: mv {{ item.item }} /tmp/vscode/
  args:
    removes: "{{ item.item }}"
  loop: "{{ vscode_stats.results }}"
  when: item.stat.exists and not item.stat.islnk
  failed_when: false

- name: Deploy VS Code dotfiles
  command: stow -v -d {{ setup_repo }}/dotfiles/ -t ~ vscode
  register: stow_vscode
  changed_when: "'LINK' in (stow_vscode.stderr | default(''))"
